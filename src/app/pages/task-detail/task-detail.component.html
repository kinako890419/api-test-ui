<div class="task-detail-container">
  <!-- Error State -->
  <div *ngIf="error()" class="error-state">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <span class="error-message">{{ error() }}</span>
  </div>

  <!-- Main Task Card -->
  <mat-card *ngIf="!error() && task() as t" class="task-card elevation-2">
    <!-- Task Header -->
    <mat-card-header class="task-header">
      <mat-card-title class="task-title">{{ t.task_name }}</mat-card-title>
      <mat-card-subtitle class="task-subtitle">
        <mat-icon class="status-icon">{{ statusIcon(t.status) }}</mat-icon>
        <!-- <span class="status-text">{{ getStatusLabel(t.status) }}</span> -->
        <mat-chip [class]="'status-chip status-' + t.status.toLowerCase()">
          {{ getStatusLabel(t.status) }}
        </mat-chip>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="task-content">
      <!-- Task Description -->
      <div class="description-section">
        <p *ngIf="!editing()" class="task-description">
          {{ t.description || 'No description provided' }}
        </p>

        <div class="action-buttons">
        <button 
          *ngIf="!editing() && t.is_editable" 
          mat-stroked-button 
          color="primary" 
          (click)="toggleEdit()"
          class="edit-btn">
          <mat-icon>edit</mat-icon>
          Edit Task
        </button>
        
        <button 
          *ngIf="t.is_editable" 
          mat-stroked-button 
          color="warn" 
          (click)="deleteTask()"
          class="delete-btn">
          <mat-icon>delete</mat-icon>
          Delete Task
        </button>
      </div>
        
        <!-- Edit Form -->
        <div *ngIf="editing()" class="edit-form">
          <h4 class="edit-title">Edit Task</h4>
          
          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Task Name</mat-label>
            <input 
              matInput 
              [(ngModel)]="form.task_name" 
              maxlength="50" 
              [disabled]="onlyStatusEditable()"
              placeholder="Enter task name" />
            <mat-hint>{{ form.task_name?.length || 0 }}/50</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Description</mat-label>
            <textarea 
              matInput 
              [(ngModel)]="form.task_description" 
              rows="4" 
              maxlength="250" 
              [disabled]="onlyStatusEditable()"
              placeholder="Describe the task..."></textarea>
            <mat-hint>{{ form.task_description?.length || 0 }}/250</mat-hint>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field half-width">
              <mat-label>Status</mat-label>
              <mat-select [(ngModel)]="form.status">
                <mat-option value="PENDING">
                  <mat-icon>schedule</mat-icon>
                  Pending
                </mat-option>
                <mat-option value="IN_PROGRESS">
                  <mat-icon>work</mat-icon>
                  In Progress
                </mat-option>
                <mat-option value="COMPLETED">
                  <mat-icon>check_circle</mat-icon>
                  Completed
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field half-width">
              <mat-label>Deadline</mat-label>
              <input 
                matInput 
                [matDatepicker]="picker" 
                [(ngModel)]="deadlineDate" 
                [disabled]="onlyStatusEditable()" 
                placeholder="Select deadline" />
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="toggleEdit()" class="cancel-btn">
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="save()" 
              [disabled]="saving()"
              class="save-btn">
              <mat-icon>save</mat-icon>
              {{ saving() ? 'Saving...' : 'Save Changes' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Task Metadata -->
      <div class="metadata-section">
        <div class="metadata-grid">
          <div class="metadata-item">
            <mat-icon>person</mat-icon>
            <span class="metadata-label">Creator:</span>
            <span class="metadata-value">{{ t.creator_name }}</span>
          </div>
          <div class="metadata-item">
            <mat-icon>event</mat-icon>
            <span class="metadata-label">Created:</span>
            <span class="metadata-value">{{ format(t.created_at) }}</span>
          </div>
          <div *ngIf="t.updated_at" class="metadata-item">
            <mat-icon>update</mat-icon>
            <span class="metadata-label">Updated:</span>
            <span class="metadata-value">{{ format(t.updated_at) }}</span>
          </div>
          <div *ngIf="t.deadline" class="metadata-item">
            <mat-icon>schedule</mat-icon>
            <span class="metadata-label">Deadline:</span>
            <span class="metadata-value">{{ format(t.deadline) }}</span>
          </div>
        </div>
      </div>

      <!-- Members Section -->
      <div class="section members-section">
        <h3 class="section-title">
          <mat-icon>group</mat-icon>
          Members ({{ t.member_lists?.length || 0 }})
        </h3>

        <!-- Invite Form -->
        <div *ngIf="t.is_editable" class="invite-section">
          <mat-form-field appearance="outline" class="invite-field">
            <mat-label>Add team members</mat-label>
            <mat-select [(ngModel)]="inviteUserIds" multiple>
              <mat-option 
                *ngFor="let m of projectMembers()" 
                [value]="m.user_id" 
                [disabled]="isAlreadyTaskMember(m.user_id)">
                <div class="user-option">
                  <span class="user-name">{{ m.user_name }}</span>
                  <span class="user-email">{{ m.user_email }}</span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="inviteToTask()" 
            [disabled]="inviteUserIds.length === 0 || savingInvite()"
            class="invite-btn">
            <mat-icon>person_add</mat-icon>
            {{ savingInvite() ? 'Adding...' : 'Add Selected' }}
          </button>
        </div>

        <!-- Members List -->
        <div class="members-list">
          <div *ngFor="let m of t.member_lists || []" class="member-item">
            <div class="member-info">
              <mat-icon class="member-icon">person</mat-icon>
              <div class="member-details">
                <span class="member-name">{{ m.user_name }}</span>
                <span class="member-email">{{ m.user_email }}</span>
              </div>
            </div>
            <button 
              *ngIf="t.is_editable" 
              mat-icon-button 
              color="warn" 
              (click)="removeFromTask(m.user_id)" 
              [disabled]="removingUserId() === m.user_id"
              class="remove-btn"
              matTooltip="Remove member">
              <mat-icon>person_remove</mat-icon>
            </button>
          </div>
          <div *ngIf="(t.member_lists?.length || 0) === 0" class="empty-state">
            <mat-icon>person_outline</mat-icon>
            <span>No members assigned</span>
          </div>
        </div>
      </div>

      <!-- Tags Section -->
      <div class="section tags-section">
        <h3 class="section-title">
          <mat-icon>label</mat-icon>
          Tags
        </h3>

        <div class="tags-content">
          <mat-chip-set class="tags-list">
            <mat-chip 
              *ngFor="let tag of t.tags || []" 
              class="task-tag clickable-tag"
              (click)="showTagDetails(tag)"
              [matTooltip]="'Click to view tag details'">
              <span>{{ tag.tag_name }}</span>
              <button 
                *ngIf="t.is_editable" 
                matChipRemove 
                (click)="removeTagFromTask(tag.tag_id); $event.stopPropagation()" 
                [disabled]="tagging()">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          </mat-chip-set>

          <div *ngIf="(t.tags?.length || 0) === 0" class="empty-state">
            <span>No tags applied</span>
          </div>

          <!-- Add Tag Form -->
          <div *ngIf="t.is_editable" class="add-tag-section">
            <mat-form-field appearance="outline" class="tag-select">
              <mat-label>Add project tag</mat-label>
              <mat-select [(ngModel)]="selectedTagId">
                <mat-option 
                  *ngFor="let tag of availableProjectTags()" 
                  [value]="tag.tag_id">
                  {{ tag.tag_name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <button 
              mat-raised-button 
              color="accent" 
              (click)="addTagToTask()" 
              [disabled]="!selectedTagId || tagging()"
              class="add-tag-btn">
              <mat-icon>add</mat-icon>
              {{ tagging() ? 'Adding...' : 'Add Tag' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Attachments Section -->
      <div class="section attachments-section">
        <h3 class="section-title">
          <mat-icon>attachment</mat-icon>
          Attachments ({{ t.task_attachments?.length || 0 }})
        </h3>

        <!-- Upload Section -->
        <div *ngIf="t.is_editable" class="upload-section">
          <input 
            #fileInput
            type="file" 
            (change)="onFileSelected($event)" 
            class="file-input" />
          <button 
            mat-stroked-button 
            color="primary" 
            (click)="fileInput.click()"
            class="upload-btn">
            <mat-icon>cloud_upload</mat-icon>
            Choose File
          </button>
        </div>

        <!-- Attachments List -->
        <div class="attachments-list">
          <div *ngFor="let a of t.task_attachments || []" class="attachment-item">
            <div class="attachment-info">
              <mat-icon class="attachment-icon">attach_file</mat-icon>
              <span class="attachment-name" [title]="a.content_path">{{ a.file_name }}</span>
            </div>
            <div class="attachment-actions">
              <button 
                mat-button 
                color="primary" 
                (click)="download(a.id)"
                class="download-btn">
                <mat-icon>download</mat-icon>
                Download
              </button>
              <button 
                *ngIf="t.is_editable"
                mat-icon-button 
                color="warn" 
                (click)="deleteAttachment(a.id)" 
                [disabled]="deletingId() === a.id"
                matTooltip="Delete attachment">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <div *ngIf="(t.task_attachments?.length || 0) === 0" class="empty-state">
            <span>No attachments</span>
          </div>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="section comments-section">
        <h3 class="section-title">
          <mat-icon>chat</mat-icon>
          Comments ({{ t.task_comments?.length || 0 }})
        </h3>

        <!-- Comments List -->
        <div class="comments-list">
          <div *ngFor="let c of t.task_comments || []" class="comment-item">
            <div class="comment-header">
              <div class="comment-user">
                <mat-icon class="user-icon">account_circle</mat-icon>
                <span class="user-name">{{ c.user_name }}</span>
                <span class="comment-time">{{ format(c.created_at) }}</span>
              </div>
              <div *ngIf="t.is_editable" class="comment-actions">
                <button 
                  *ngIf="editingCommentId() !== c.comment_id"
                  mat-icon-button 
                  (click)="startEditComment(c.comment_id, c.content)"
                  matTooltip="Edit comment">
                  <mat-icon>edit</mat-icon>
                </button>
                <button 
                  *ngIf="editingCommentId() !== c.comment_id"
                  mat-icon-button 
                  color="warn" 
                  (click)="deleteComment(c.comment_id)"
                  matTooltip="Delete comment">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <!-- Edit Comment Form -->
            <div *ngIf="editingCommentId() === c.comment_id" class="edit-comment-form">
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>Edit comment</mat-label>
                <textarea 
                  matInput 
                  rows="3" 
                  [ngModel]="editingCommentContent()" 
                  (ngModelChange)="editingCommentContent.set($event)"
                  maxlength="500"></textarea>
                <mat-hint>{{ editingCommentContent().length }}/500</mat-hint>
              </mat-form-field>
              <div class="form-actions">
                <button mat-button (click)="cancelEditComment()">Cancel</button>
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="saveEditComment(c.comment_id)">
                  <mat-icon>save</mat-icon>
                  Save
                </button>
              </div>
            </div>

            <!-- Comment Content -->
            <div *ngIf="editingCommentId() !== c.comment_id" class="comment-content">
              <p>{{ c.content }}</p>
            </div>
          </div>

          <div *ngIf="(t.task_comments?.length || 0) === 0" class="empty-state">
            <span>No comments</span>
          </div>
        </div>

        <!-- Add Comment Form -->
        <div *ngIf="t.is_editable" class="add-comment-section">
          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Add a comment</mat-label>
            <textarea 
              matInput 
              rows="3" 
              [ngModel]="newCommentContent()" 
              (ngModelChange)="newCommentContent.set($event)" 
              maxlength="500" 
              placeholder="Share your thoughts..."></textarea>
            <mat-hint>{{ newCommentContent().length }}/500</mat-hint>
          </mat-form-field>
          <div class="form-actions">
            <button 
              mat-raised-button 
              color="primary" 
              (click)="addComment()" 
              [disabled]="!newCommentContent().trim()"
              class="add-comment-btn">
              <mat-icon>send</mat-icon>
              Add Comment
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>

    <!-- Card Actions -->
    <mat-card-actions class="card-actions">
      <button mat-button (click)="goBack()" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
        Back to Project
      </button>
    </mat-card-actions>
  </mat-card>
</div>