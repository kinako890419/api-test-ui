<div class="task-detail-container">
  <div *ngIf="loading()" class="center">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading task...</p>
  </div>

  <div *ngIf="error()" class="error">
    <mat-icon>error_outline</mat-icon>
    {{ error() }}
  </div>

  <mat-card *ngIf="!loading() && !error() && task() as t" class="task-card">
    <mat-card-header>
      <mat-card-title>{{ t.task_name }}</mat-card-title>
      <mat-card-subtitle>
        <mat-icon>{{ statusIcon(t.status) }}</mat-icon>
        {{ t.status }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <p class="desc" *ngIf="!editing()">{{ t.description || 'No description' }}</p>
      <div class="edit-form" *ngIf="editing()">
        <mat-form-field appearance="outline" class="full">
          <mat-label>Task name</mat-label>
          <input matInput [(ngModel)]="form.task_name" maxlength="50" [disabled]="onlyStatusEditable()" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>Description</mat-label>
          <textarea matInput [(ngModel)]="form.task_description" rows="3" maxlength="250" [disabled]="onlyStatusEditable()"></textarea>
        </mat-form-field>
        <div class="row">
          <mat-form-field appearance="outline" class="half">
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="form.status">
              <mat-option value="PENDING">Pending</mat-option>
              <mat-option value="IN_PROGRESS">In Progress</mat-option>
              <mat-option value="COMPLETED">Completed</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="half">
            <mat-label>Deadline</mat-label>
            <input matInput [matDatepicker]="picker" [(ngModel)]="deadlineDate" [disabled]="onlyStatusEditable()" placeholder="Choose a date" />
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="row end">
          <button mat-button (click)="toggleEdit()">Cancel</button>
          <button mat-raised-button color="primary" (click)="save()" [disabled]="saving()">
            <mat-icon>save</mat-icon>
            Save
          </button>
        </div>
      </div>

      <div class="meta">
        <span>
          <mat-icon>person</mat-icon>
          Creator: {{ t.creator_name }}
        </span>
        <span>
          <mat-icon>event</mat-icon>
          Created: {{ format(t.created_at) }}
        </span>
        <span *ngIf="t.updated_at">
          <mat-icon>update</mat-icon>
          Updated: {{ format(t.updated_at) }}
        </span>
        <span *ngIf="t.deadline">
          <mat-icon>schedule</mat-icon>
          Deadline: {{ format(t.deadline) }}
        </span>
      </div>

      <h3>Members ({{ t.member_lists?.length || 0 }})</h3>
      <div class="invite-form" *ngIf="canManageTaskMembers()">
        <mat-form-field appearance="outline" class="invite-field">
          <mat-label>Select user to invite</mat-label>
          <mat-select [(ngModel)]="inviteUserIds" multiple>
            <mat-option *ngFor="let m of projectMembers()" [value]="m.user_id" [disabled]="isAlreadyTaskMember(m.user_id)">
              {{ m.user_name }} ({{ m.user_email }})
            </mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-raised-button color="primary" (click)="inviteToTask()" [disabled]="inviteUserIds.length === 0 || savingInvite()">
          <mat-icon>person_add</mat-icon>
          Invite selected
        </button>
      </div>
      <ul class="members">
        <li *ngFor="let m of t.member_lists || []">
          <mat-icon>person</mat-icon>
          <span>{{ m.user_name }}</span>
          <small class="muted">{{ m.user_email }}</small>
          <button mat-stroked-button color="warn" class="ml-auto" *ngIf="canManageTaskMembers()" (click)="removeFromTask(m.user_id)" [disabled]="removingUserId() === m.user_id">
            <mat-icon>person_remove</mat-icon>
            Remove
          </button>
        </li>
      </ul>

      <h3>Tags</h3>
      <div class="tags-section">
        <mat-chip-set class="mb-8">
          <mat-chip *ngFor="let tag of t.tags || []" color="primary" selected>
            {{ tag.tag_name }}
            <button mat-icon-button *ngIf="canManageTags()" (click)="removeTagFromTask(tag.tag_id)" [disabled]="tagging()" aria-label="Remove tag">
              <mat-icon>close</mat-icon>
            </button>
          </mat-chip>
          <span *ngIf="(t.tags?.length || 0) === 0" class="muted">No tags</span>
        </mat-chip-set>

        <div class="add-tag-row" *ngIf="canManageTags()">
          <mat-form-field appearance="outline" class="half">
            <mat-label>Add existing project tag</mat-label>
            <mat-select [(ngModel)]="selectedTagId">
              <mat-option *ngFor="let tag of availableProjectTags()" [value]="tag.tag_id">
                {{ tag.tag_name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="addTagToTask()" [disabled]="!selectedTagId || tagging()">
            <mat-icon>add</mat-icon>
            Add Tag
          </button>
        </div>
      </div>

      <h3>Attachments ({{ t.task_attachments?.length || 0 }})</h3>
      <div class="upload-row">
        <input type="file" (change)="onFileSelected($event)" [disabled]="uploading()" />
        <mat-spinner *ngIf="uploading()" diameter="20"></mat-spinner>
      </div>
      <ul class="attachments">
        <li *ngFor="let a of t.task_attachments || []">
          <mat-icon>attach_file</mat-icon>
          <span class="file" [title]="a.content_path">{{ a.file_name }}</span>
          <button mat-button color="primary" (click)="download(a.id)">
            <mat-icon>download</mat-icon>
            Download
          </button>
          <button mat-stroked-button color="warn" (click)="deleteAttachment(a.id)" [disabled]="deletingId() === a.id">
            <mat-icon>delete</mat-icon>
            Delete
          </button>
        </li>
        <li *ngIf="(t.task_attachments?.length || 0) === 0" class="muted">No attachments</li>
      </ul>

      <h3>Comments ({{ t.task_comments?.length || 0 }})</h3>
      <div class="comments">
        <div class="comment" *ngFor="let c of t.task_comments || []">
          <div class="comment-header">
            <mat-icon>chat</mat-icon>
            <strong>{{ c.user_name }}</strong>
            <span class="time">{{ format(c.created_at) }}</span>
            <span class="spacer"></span>
            <ng-container *ngIf="canEditComment(c.user_name)">
              <button mat-button color="primary" (click)="startEditComment(c.comment_id, c.content)" *ngIf="editingCommentId() !== c.comment_id">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
              <button mat-stroked-button color="warn" (click)="deleteComment(c.comment_id)" *ngIf="editingCommentId() !== c.comment_id">
                <mat-icon>delete</mat-icon>
                Delete
              </button>
            </ng-container>
          </div>
          <div *ngIf="editingCommentId() === c.comment_id; else viewComment">
            <mat-form-field appearance="outline" class="full">
              <mat-label>Edit comment</mat-label>
              <textarea matInput rows="3" [ngModel]="editingCommentContent()" (ngModelChange)="editingCommentContent.set($event)"></textarea>
            </mat-form-field>
            <div class="row end">
              <button mat-button (click)="cancelEditComment()">Cancel</button>
              <button mat-raised-button color="primary" (click)="saveEditComment(c.comment_id)">
                <mat-icon>save</mat-icon>
                Save
              </button>
            </div>
          </div>
          <ng-template #viewComment>
            <p class="comment-content">{{ c.content }}</p>
          </ng-template>
        </div>
        <div *ngIf="(t.task_comments?.length || 0) === 0" class="muted">No comments</div>

        <div class="add-comment" *ngIf="canAddComment()">
          <mat-form-field appearance="outline" class="full">
            <mat-label>New comment</mat-label>
            <textarea matInput rows="3" [ngModel]="newCommentContent()" (ngModelChange)="newCommentContent.set($event)" maxlength="500" placeholder="Write a comment..."></textarea>
          </mat-form-field>
          <div class="row end">
            <button mat-raised-button color="primary" (click)="addComment()" [disabled]="!newCommentContent().trim()">
              <mat-icon>send</mat-icon>
              Add Comment
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to Project
      </button>
      <button mat-stroked-button color="primary" (click)="toggleEdit()" *ngIf="!editing() && t.is_editable">
        <mat-icon>edit</mat-icon>
        Edit
      </button>
      <button mat-stroked-button color="warn" (click)="deleteTask()" *ngIf="t.is_editable">
        <mat-icon>delete</mat-icon>
        Delete
      </button>
    </mat-card-actions>
  </mat-card>
</div>
